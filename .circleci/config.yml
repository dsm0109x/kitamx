version: 2.1

# ============================================
# WORKFLOWS
# Test and deploy pipeline with correct SSH config
# ============================================
workflows:
  test-and-deploy:
    jobs:
      # Corre tests en todas las branches
      - test:
          filters:
            branches:
              only: /.*/

      # Security checks - BLOQUEANTE para production
      - security-checks:
          requires:
            - test
          filters:
            branches:
              only: production

      # Deploy solo en production branch (despu√©s de tests Y security)
      - deploy:
          requires:
            - test
            - security-checks
          filters:
            branches:
              only: production

      # Jobs NO bloqueantes (corren en paralelo despu√©s de deploy)
      - dependency-audit:
          requires:
            - deploy
          filters:
            branches:
              only: production

      - code-quality:
          requires:
            - deploy
          filters:
            branches:
              only: production

# ============================================
# JOBS
# ============================================
jobs:
  # --------------------------------------------
  # JOB: Test (Lightweight - solo syntax check)
  # --------------------------------------------
  test:
    machine:
      image: ubuntu-2204:2024.01.1

    steps:
      - checkout

      # Verificaci√≥n b√°sica: Python syntax check
      - run:
          name: Python syntax check
          command: |
            python3 -m py_compile kita/settings.py
            python3 -m py_compile manage.py
            echo "‚úÖ Python syntax OK"

      # Verificar que requirements.txt es v√°lido
      - run:
          name: Check requirements.txt
          command: |
            if [ ! -f requirements.txt ]; then
              echo "‚ùå requirements.txt not found"
              exit 1
            fi
            echo "‚úÖ requirements.txt exists"

      # Verificar archivos cr√≠ticos
      - run:
          name: Verify critical files
          command: |
            test -f deployment/deploy.sh || (echo "‚ùå deploy.sh missing" && exit 1)
            test -f manage.py || (echo "‚ùå manage.py missing" && exit 1)
            test -d kita || (echo "‚ùå kita/ directory missing" && exit 1)
            echo "‚úÖ All critical files present"

  # --------------------------------------------
  # JOB: Deploy
  # --------------------------------------------
  deploy:
    machine:
      image: ubuntu-2204:2024.01.1

    steps:
      - checkout

      # Deploy via SSH usando sshpass con contrase√±a
      - run:
          name: Install sshpass
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y -qq sshpass

      - run:
          name: Deploy to production server
          command: |
            # Conectar al servidor usando sshpass y ejecutar deployment
            sshpass -p "$CIRCLECI_SSH_PASSWORD" ssh -o StrictHostKeyChecking=no circleci@159.203.124.1 'bash -s' < deployment/deploy.sh

      # Health check post-deploy
      - run:
          name: Health check
          command: |
            echo "‚è≥ Waiting for services to restart..."
            sleep 10
            curl -f https://kita.mx/health/ && echo "‚úÖ Health check passed" || echo "‚ö†Ô∏è  Health check failed"

  # --------------------------------------------
  # JOB: Security Checks (BLOQUEANTE)
  # --------------------------------------------
  security-checks:
    machine:
      image: ubuntu-2204:2024.01.1

    steps:
      - checkout

      # Gitleaks - Escanear secrets en c√≥digo
      - run:
          name: Scan for leaked secrets with Gitleaks
          command: |
            echo "üîç Installing Gitleaks..."
            wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
            tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
            chmod +x gitleaks

            echo "üîê Scanning repository for leaked secrets..."
            ./gitleaks detect --source=. --no-git --verbose --exit-code=1 || {
              echo ""
              echo "‚ùå CRITICAL: Secrets or credentials found in code!"
              echo "   Review the findings above and remove sensitive data"
              echo "   Common issues:"
              echo "   - API keys, tokens, passwords in code"
              echo "   - Private keys or certificates"
              echo "   - Database credentials"
              echo ""
              exit 1
            }

            echo "‚úÖ No secrets found in repository"

      # Verificar que DEBUG est√© en False
      - run:
          name: Check DEBUG mode is disabled
          command: |
            echo "üîí Checking DEBUG mode..."
            if grep -q "DEBUG.*=.*True" kita/settings.py; then
              echo "‚ùå CRITICAL: DEBUG is True in settings.py"
              echo "   This is a SECURITY RISK in production!"
              exit 1
            fi

            # Verificar que no haya DEBUG=True hardcodeado
            if grep -rn "DEBUG\s*=\s*True" --include="*.py" kita/ core/ accounts/ payments/ invoicing/ 2>/dev/null; then
              echo "‚ö†Ô∏è  WARNING: Found DEBUG=True in code (may be OK if conditional)"
            fi

            echo "‚úÖ DEBUG mode check passed"

      # Django Security Settings Validator (Robusto)
      - run:
          name: Validate Django production security settings
          command: |
            echo "üîí Validating Django security configuration..."

            # Crear script temporal
            cat > /tmp/security_audit.py << 'ENDPY'
import re
import sys

with open("kita/settings.py", "r") as f:
    settings_content = f.read()

print("=" * 60)
print("üîê DJANGO SECURITY CONFIGURATION AUDIT")
print("=" * 60)
print()

critical_failures = []
warnings = []

# 1. SECRET_KEY
print("1Ô∏è‚É£  SECRET_KEY Configuration")
if re.search(r"SECRET_KEY\s*=\s*['\"][^{$]", settings_content):
    critical_failures.append("SECRET_KEY is hardcoded")
    print("   ‚ùå FAIL: SECRET_KEY is hardcoded")
elif re.search(r"SECRET_KEY\s*=\s*env\(", settings_content):
    print("   ‚úÖ PASS: SECRET_KEY from environment")
else:
    warnings.append("SECRET_KEY unclear")
    print("   ‚ö†Ô∏è  WARN: SECRET_KEY configuration unclear")

# 2. DEBUG
print("\n2Ô∏è‚É£  DEBUG Mode")
if re.search(r"DEBUG\s*=\s*True(?!\s*#)", settings_content):
    critical_failures.append("DEBUG hardcoded to True")
    print("   ‚ùå FAIL: DEBUG=True hardcoded")
elif re.search(r"DEBUG\s*=\s*env\(", settings_content):
    print("   ‚úÖ PASS: DEBUG from environment")
else:
    warnings.append("DEBUG unclear")
    print("   ‚ö†Ô∏è  WARN: DEBUG not from environment")

# 3. ALLOWED_HOSTS
print("\n3Ô∏è‚É£  ALLOWED_HOSTS")
if re.search(r"ALLOWED_HOSTS\s*=\s*\[\s*['\"]?\*['\"]?\s*\]", settings_content):
    critical_failures.append("ALLOWED_HOSTS allows all")
    print("   ‚ùå FAIL: ALLOWED_HOSTS=['*'] is dangerous")
elif re.search(r"ALLOWED_HOSTS\s*=\s*env", settings_content):
    print("   ‚úÖ PASS: From environment")
else:
    print("   ‚úÖ PASS: Configured")

# 4. Security Headers
print("\n4Ô∏è‚É£  Security Headers")
checks = ["SECURE_SSL_REDIRECT", "SESSION_COOKIE_SECURE", "CSRF_COOKIE_SECURE", "SECURE_HSTS_SECONDS", "X_FRAME_OPTIONS"]
for check in checks:
    if re.search(check + r"\s*=\s*True|\s*=\s*\d+", settings_content):
        print(f"   ‚úÖ {check}")
    else:
        warnings.append(f"{check} not set")
        print(f"   ‚ö†Ô∏è  {check} not found")

# 5. Database
print("\n5Ô∏è‚É£  Database")
if "sqlite3" in settings_content.lower():
    if re.search(r"if\s+DEBUG", settings_content):
        print("   ‚úÖ PASS: SQLite only in DEBUG")
    else:
        warnings.append("SQLite in production")
        print("   ‚ö†Ô∏è  WARN: SQLite may be in production")
else:
    print("   ‚úÖ PASS: Production database")

# 6. debug_toolbar
print("\n6Ô∏è‚É£  Debug Toolbar")
if "debug_toolbar" in settings_content:
    warnings.append("debug_toolbar enabled")
    print("   ‚ö†Ô∏è  WARN: debug_toolbar in INSTALLED_APPS")
else:
    print("   ‚úÖ PASS: Not installed")

# Resultado
print("\n" + "=" * 60)
print("üìä RESULTS")
print("=" * 60)

if critical_failures:
    print(f"\n‚ùå CRITICAL ({len(critical_failures)}):")
    for f in critical_failures:
        print(f"   ‚Ä¢ {f}")
    print("\nüö´ DEPLOYMENT BLOCKED")
    sys.exit(1)

if warnings:
    print(f"\n‚ö†Ô∏è  WARNINGS ({len(warnings)}):")
    for w in warnings:
        print(f"   ‚Ä¢ {w}")

print("\n‚úÖ SECURITY AUDIT PASSED")
print("=" * 60)
ENDPY

            python3 /tmp/security_audit.py

      # Verificar que no haya credenciales hardcodeadas
      - run:
          name: Check for hardcoded credentials
          command: |
            echo "üîê Scanning for hardcoded credentials..."

            # Buscar patrones sospechosos
            FOUND=0

            if grep -rn "password\s*=\s*['\"][^'\"{}$]" --include="*.py" . 2>/dev/null | grep -v "venv/" | grep -v ".git/"; then
              echo "‚ö†Ô∏è  WARNING: Potential hardcoded passwords found"
              FOUND=1
            fi

            if grep -rn "api[_-]key\s*=\s*['\"][^'\"{}$]" --include="*.py" . 2>/dev/null | grep -v "venv/" | grep -v ".git/"; then
              echo "‚ö†Ô∏è  WARNING: Potential hardcoded API keys found"
              FOUND=1
            fi

            if [ $FOUND -eq 0 ]; then
              echo "‚úÖ No obvious hardcoded credentials found"
            else
              echo "‚ö†Ô∏è  Review warnings above (non-blocking)"
            fi

      # Verificar archivos sensibles no est√©n en git
      - run:
          name: Check sensitive files
          command: |
            echo "üìÅ Checking for sensitive files..."

            if [ -f .env ]; then
              echo "‚ùå CRITICAL: .env file found in repository!"
              exit 1
            fi

            if find . -name "*.pem" -o -name "*.key" -o -name "credentials.json" 2>/dev/null | grep -v ".git/" | grep -v "venv/"; then
              echo "‚ö†Ô∏è  WARNING: Potential sensitive files in repository"
            else
              echo "‚úÖ No sensitive files in repository"
            fi

  # --------------------------------------------
  # JOB: Dependency Audit (NO BLOQUEANTE)
  # --------------------------------------------
  dependency-audit:
    machine:
      image: ubuntu-2204:2024.01.1

    steps:
      - checkout

      - run:
          name: Install pip-audit
          command: |
            python3 -m pip install pip-audit --quiet

      - run:
          name: Audit dependencies for vulnerabilities
          command: |
            echo "üîç Auditing dependencies for known vulnerabilities..."

            # Continuar incluso si encuentra vulnerabilidades
            python3 -m pip_audit -r requirements.txt --desc || {
              echo "‚ö†Ô∏è  Vulnerabilities found in dependencies"
              echo "   This is informational - deployment already completed"
              echo "   Review and update dependencies when possible"
              exit 0  # No bloquear
            }

            echo "‚úÖ No known vulnerabilities in dependencies"

      - run:
          name: Check for outdated packages
          when: always
          command: |
            echo "üì¶ Checking for outdated packages..."
            python3 -m pip install pip-review --quiet
            python3 -m pip_review --raw || echo "Some packages have updates available"

  # --------------------------------------------
  # JOB: Code Quality (NO BLOQUEANTE)
  # --------------------------------------------
  code-quality:
    machine:
      image: ubuntu-2204:2024.01.1

    steps:
      - checkout

      - run:
          name: Install linting tools
          command: |
            python3 -m pip install flake8 bandit --quiet

      - run:
          name: Run flake8 linter
          when: always
          command: |
            echo "üîç Running flake8 linter..."

            # Configuraci√≥n permisiva para no ser muy estricto
            python3 -m flake8 . \
              --exclude=venv,migrations,.git,__pycache__,staticfiles \
              --max-line-length=120 \
              --ignore=E501,W503,E203 \
              --count \
              --statistics || {
              echo "‚ö†Ô∏è  Linting issues found (informational)"
              exit 0
            }

            echo "‚úÖ Code passes linting"

      - run:
          name: Run Bandit security scanner
          when: always
          command: |
            echo "üîí Running Bandit security scanner..."

            # Escanear c√≥digo buscando problemas de seguridad comunes
            python3 -m bandit -r . \
              -x venv,tests,migrations,.git \
              -ll \
              -f screen || {
              echo "‚ö†Ô∏è  Security issues found (informational)"
              exit 0
            }

            echo "‚úÖ No security issues found"
