<!-- User Sessions Panel -->
<div class="d-flex align-items-center mb-3">
    <div class="bg-warning rounded-circle p-2 me-3">
        <i class="iconoir-shield-check text-white"></i>
    </div>
    <div>
        <h6 class="mb-0">Sesiones Activas</h6>
        <small class="text-muted">Administra tus sesiones de seguridad</small>
    </div>
</div>

<!-- Sesión Actual -->
<div class="alert alert-info">
    <i class="iconoir-info-circle me-2"></i>
    <strong>Sesión Actual:</strong> Esta es la sesión que estás usando ahora.
    No puedes revocarla desde aquí.
</div>

<!-- Sesiones Activas -->
{% if active_sessions %}
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Dispositivo</th>
                    <th>Dirección IP</th>
                    <th>Última Actividad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for session in active_sessions %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if 'Mobile' in session.user_agent %}
                                <i class="iconoir-phone me-2 text-muted"></i>
                            {% elif 'Tablet' in session.user_agent %}
                                <i class="iconoir-tablet me-2 text-muted"></i>
                            {% else %}
                                <i class="iconoir-laptop me-2 text-muted"></i>
                            {% endif %}
                            <div>
                                {% if 'Chrome' in session.user_agent %}
                                    Chrome
                                {% elif 'Firefox' in session.user_agent %}
                                    Firefox
                                {% elif 'Safari' in session.user_agent %}
                                    Safari
                                {% elif 'Edge' in session.user_agent %}
                                    Edge
                                {% else %}
                                    Navegador
                                {% endif %}
                                <small class="text-muted d-block">
                                    {% if 'Mobile' in session.user_agent %}
                                        Móvil
                                    {% elif 'Tablet' in session.user_agent %}
                                        Tablet
                                    {% else %}
                                        Escritorio
                                    {% endif %}
                                    {% if session.city and session.country %}
                                        • {{ session.city }}, {{ session.country }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <code class="small">{{ session.ip_address }}</code>
                    </td>
                    <td>
                        <small>hace {{ session.last_activity|timesince }}</small>
                        {% if session.last_activity|timesince|slice:":1" == "0" %}
                            <span class="badge bg-success d-block mt-1">Ahora</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm" onclick="revokeSession('{{ session.id }}', '{{ session.ip_address }}')">
                            <i class="iconoir-xmark me-1"></i>
                            Revocar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <div class="alert alert-warning">
            <i class="iconoir-warning-triangle me-2"></i>
            <strong>Importante:</strong> Si revocas una sesión, se cerrará inmediatamente en ese dispositivo.
            Tendrás que iniciar sesión nuevamente.
        </div>
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="iconoir-shield-check" style="font-size: 3rem; color: #9ca3af; margin-bottom: 1rem;"></i>
        <h6 class="text-muted">No hay otras sesiones activas</h6>
        <p class="text-muted">Solo tu sesión actual.</p>
    </div>
{% endif %}

<script>
function revokeSession(sessionId, ipAddress) {
    if (confirm(`¿Revocar sesión desde ${ipAddress}?\n\nEsta acción cerrará la sesión inmediatamente.`)) {
        fetch('{% url "accounts:revoke_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Recargar el panel lateral después de 1 segundo
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'Error revocando sesión', 'error');
            }
        })
        .catch(error => {
            showToast('Error de conexión', 'error');
        });
    }
}
</script>