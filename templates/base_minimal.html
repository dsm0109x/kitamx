<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Kita - SaaS Facturación CFDI 4.0{% endblock %}</title>

    <!-- Mobile Browser Theme Color -->
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileColor" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- SEO Meta Tags -->
    <meta name="description" content="{{ meta_description|default:'Kita - Plataforma mexicana para crear enlaces de pago y generar facturas CFDI 4.0 automáticamente. 30 días gratis.' }}">
    {% if meta_keywords %}<meta name="keywords" content="{{ meta_keywords }}">{% endif %}
    <link rel="canonical" href="{{ canonical_url|default:request.build_absolute_uri }}">

    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:title" content="{{ title|default:'Kita - Cobra y Factura CFDI 4.0 Sin Complicaciones' }}">
    <meta property="og:description" content="{{ meta_description|default:'Crea enlaces de pago y genera facturas CFDI 4.0 automáticamente. Ideal para freelancers y emprendedores en México.' }}">
    <meta property="og:image" content="{{ og_image|default:'https://kita.mx/static/images/kita-logo-negro.png' }}">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:url" content="{{ canonical_url|default:request.build_absolute_uri }}">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="es_MX">
    <meta property="og:site_name" content="Kita">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@kita_mx">
    <meta name="twitter:creator" content="@kita_mx">
    <meta name="twitter:title" content="{{ title|default:'Kita - Cobra y Factura CFDI 4.0 Sin Complicaciones' }}">
    <meta name="twitter:description" content="{{ meta_description|default:'Crea enlaces de pago y genera facturas CFDI 4.0 automáticamente.' }}">
    <meta name="twitter:image" content="{{ og_image|default:'https://kita.mx/static/images/kita-logo-negro.png' }}">
    <meta name="twitter:image:alt" content="Kita - Plataforma de enlaces de pago y facturación CFDI 4.0">

    <!-- Favicons (multi-size for optimal display) -->
    {% load static %}
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon/favicon-16x16.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/favicon/apple-touch-icon.png' %}">
    <link rel="manifest" href="{% static 'images/favicon/site.webmanifest' %}">

    <!-- DNS Prefetch & Preconnect for CDNs (Performance) -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">

    <!-- Typography: Inter (UI) + DM Serif Display (Brand) -->
    <link rel="stylesheet" href="{% static 'css/01-base/fonts.css' %}">
    <link rel="stylesheet" href="{% static 'css/01-base/brand-typography.css' %}">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <!-- Iconoir Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/iconoir-icons/iconoir@main/css/iconoir.css">

    <!-- Toastify CSS -->
    <link rel="stylesheet"
          type="text/css"
          href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify JS - Required for notifications (must load before showToast function) -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>

    <!-- Unified Design Tokens (MUST load FIRST) -->
    <link rel="stylesheet" href="{% static 'css/00-tokens/design-tokens-unified.css' %}?v=4.0">

    <!-- BASE COMPONENTS - Single Source of Truth (DRY System) -->
    <link rel="stylesheet" href="{% static 'css/01-base/base-components.css' %}?v=1.0">
    <link rel="stylesheet" href="{% static 'css/01-base/alerts.css' %}?v=1.0">

    <!-- Components -->
    <link rel="stylesheet" href="{% static 'css/02-components/buttons.css' %}?v=3.2">
    <link rel="stylesheet" href="{% static 'css/02-components/cookie-consent.css' %}">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/kita.css' %}?v=21.0">

    <!-- Effects for landing (functional only) -->
    <link rel="stylesheet" href="{% static 'css/05-effects/comparison.css' %}">
    <link rel="stylesheet" href="{% static 'css/05-effects/roi-calculator.css' %}">

    <!-- Page-specific styles (loaded before overrides) -->
    {% block extra_head %}{% endblock %}

    <!-- BRUTALIST OVERRIDES (MUST load LAST) -->
    <link rel="stylesheet" href="{% static 'css/00-tokens/brutalist-overrides.css' %}?v=3.5">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7K5TD53TK2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}

        // Set default consent to denied (GDPR requirement)
        gtag('consent', 'default', {
            'analytics_storage': 'denied',
            'ad_storage': 'denied',
            'ad_user_data': 'denied',
            'ad_personalization': 'denied',
            'wait_for_update': 500
        });

        gtag('js', new Date());
        gtag('config', 'G-7K5TD53TK2');
    </script>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">
        Saltar al contenido principal
    </a>

    <!-- Smart Loading System - Global -->
    <div class="loading-topbar" id="loadingTopbar">
        <div class="loading-topbar-progress"></div>
    </div>

    <div class="loading-message-card" id="loadingMessage">
        <div class="d-flex align-items-center">
            <span class="spinner-border spinner-border-sm me-2"></span>
            <span id="loadingText">Cargando...</span>
        </div>
    </div>

    {% block content %}
    {% endblock %}



    <!-- Cookie Consent (GDPR) -->
    <script src="{% static 'js/cookie-consent.js' %}" defer></script>

    <!-- Error Recovery System -->
    <script src="{% static 'js/error-recovery-system.js' %}?v=1.0" defer></script>

    <!-- Loading Progress System -->
    <script src="{% static 'js/loading-progress-system.js' %}?v=2.0" defer></script>

    <!-- Bootstrap 5 JS Bundle (required for navbar collapse - loaded sync before other scripts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
            async></script>

    <!-- Kita Global JS (deprecated - mantenido por compatibilidad) -->
    <script>
    // Global Toastify function
    window.showToast = function(message, type = 'info') {
        const colors = {
            success: '#28a745',
            error: '#dc3545',
            warning: '#ffc107',
            info: '#17a2b8'
        };

        // Ensure Toastify is loaded before showing toast
        function tryShowToast() {
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: message,
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    stopOnFocus: true,
                    backgroundColor: colors[type] || colors.info,
                }).showToast();
            } else {
                // Retry after a short delay if Toastify isn't loaded yet
                setTimeout(tryShowToast, 100);
            }
        }

        tryShowToast();
    };

    // Show Django messages as toasts (with delay to ensure scripts loaded)
    {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure Toastify is fully loaded
            setTimeout(function() {
                {% for message in messages %}
                    showToast("{{ message|escapejs }}", "{{ message.tags }}");
                {% endfor %}
            }, 100);
        });
    {% endif %}

    // Global loading system functions with auto-timeout
    window.showLoading = function(message = 'Cargando...', timeout = 30000) {
        const topbar = document.getElementById('loadingTopbar');
        const card = document.getElementById('loadingMessage');
        const text = document.getElementById('loadingText');

        if (topbar) topbar.classList.add('active');
        if (card) card.classList.add('active');
        if (text) text.textContent = message;

        // Auto-hide después de timeout para prevenir loading infinito
        if (window._loadingTimeout) {
            clearTimeout(window._loadingTimeout);
        }

        window._loadingTimeout = setTimeout(() => {
            hideLoading();
            showToast('La operación está tardando más de lo esperado', 'warning');
        }, timeout);
    };

    window.hideLoading = function() {
        const topbar = document.getElementById('loadingTopbar');
        const card = document.getElementById('loadingMessage');

        if (topbar) topbar.classList.remove('active');
        if (card) card.classList.remove('active');

        // Limpiar timeout
        if (window._loadingTimeout) {
            clearTimeout(window._loadingTimeout);
            window._loadingTimeout = null;
        }
    };
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
