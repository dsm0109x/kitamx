{% extends 'dashboard/base.html' %}
{% load humanize static %}

{% block title %}Facturar Suscripci贸n - {{ tenant.name }}{% endblock %}

{% block dashboard_content %}
<!-- Page Header -->
<div class="settings-page-header" style="margin-bottom: 2rem;">
    <h1>Facturar Suscripci贸n</h1>
    <p style="color: #6b7280; font-size: 0.875rem;">
        Genera tu factura CFDI 4.0 para el pago de suscripci贸n a Kita
    </p>
</div>

<!-- Payment Details Card -->
<div style="background: white; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 2rem;">
    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; text-transform: uppercase; color: #111827;">
        Detalles del Pago
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Periodo</div>
            <div style="font-weight: 600;">{{ payment.billing_period_start|date:"F Y" }}</div>
        </div>
        <div>
            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Monto</div>
            <div style="font-weight: 600;">${{ payment.amount|floatformat:2 }} {{ payment.currency }}</div>
        </div>
        <div>
            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">Fecha de Pago</div>
            <div style="font-weight: 600;">{{ payment.created_at|date:"d/m/Y H:i" }}</div>
        </div>
        <div>
            <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase;">M茅todo</div>
            <div style="font-weight: 600;">{{ payment.get_payment_method_display }}</div>
        </div>
    </div>
</div>

<!-- Invoice Form -->
<form method="POST" id="invoice-form">
    {% csrf_token %}

    <div style="background: white; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 2rem;">
        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; text-transform: uppercase; color: #111827;">
            Datos Fiscales del Receptor
        </h3>

        <div class="alert" style="background: #f0fdfa; border-left: 3px solid #0d9488; padding: 1rem; margin-bottom: 1.5rem;">
            <strong style="font-size: 0.875rem;">癸 Datos autocompletados</strong>
            <p style="font-size: 0.8125rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                Los datos se han pre-llenado con la informaci贸n de tu cuenta. Verifica que sean correctos.
            </p>
        </div>

        <!-- RFC (editable) -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                RFC <span style="color: #ef4444;">*</span>
            </label>
            <input type="text"
                   class="form-control"
                   name="rfc"
                   value="{{ rfc }}"
                   required
                   pattern="[A-Z&]{3,4}[0-9]{6}[A-Z0-9]{3}"
                   maxlength="13"
                   style="border: 1px solid #e5e7eb;">
            <small class="form-text text-muted">RFC de quien recibir谩 la factura (modificable)</small>
        </div>

        <!-- Raz贸n Social (editable) -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                Raz贸n Social <span style="color: #ef4444;">*</span>
            </label>
            <input type="text"
                   class="form-control"
                   name="business_name"
                   value="{{ business_name }}"
                   required
                   maxlength="255"
                   style="border: 1px solid #e5e7eb;">
            <small class="form-text text-muted">Nombre o raz贸n social del receptor (modificable)</small>
        </div>

        <!-- R茅gimen Fiscal (editable con select) -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                R茅gimen Fiscal <span style="color: #ef4444;">*</span>
            </label>
            <select class="form-select" name="fiscal_regime" required style="border: 1px solid #e5e7eb;">
                <option value="">Selecciona r茅gimen...</option>
                <option value="601" {% if fiscal_regime == '601' %}selected{% endif %}>601 - General de Ley Personas Morales</option>
                <option value="603" {% if fiscal_regime == '603' %}selected{% endif %}>603 - Personas Morales con Fines no Lucrativos</option>
                <option value="605" {% if fiscal_regime == '605' %}selected{% endif %}>605 - Sueldos y Salarios</option>
                <option value="606" {% if fiscal_regime == '606' %}selected{% endif %}>606 - Arrendamiento</option>
                <option value="607" {% if fiscal_regime == '607' %}selected{% endif %}>607 - Enajenaci贸n o Adquisici贸n de Bienes</option>
                <option value="608" {% if fiscal_regime == '608' %}selected{% endif %}>608 - Dem谩s ingresos</option>
                <option value="610" {% if fiscal_regime == '610' %}selected{% endif %}>610 - Residentes en el Extranjero</option>
                <option value="611" {% if fiscal_regime == '611' %}selected{% endif %}>611 - Ingresos por Dividendos</option>
                <option value="612" {% if fiscal_regime == '612' %}selected{% endif %}>612 - Personas F铆sicas con Actividades Empresariales</option>
                <option value="614" {% if fiscal_regime == '614' %}selected{% endif %}>614 - Ingresos por intereses</option>
                <option value="615" {% if fiscal_regime == '615' %}selected{% endif %}>615 - Ingresos por premios</option>
                <option value="616" {% if fiscal_regime == '616' %}selected{% endif %}>616 - Sin obligaciones fiscales</option>
                <option value="621" {% if fiscal_regime == '621' %}selected{% endif %}>621 - Incorporaci贸n Fiscal</option>
                <option value="622" {% if fiscal_regime == '622' %}selected{% endif %}>622 - Actividades Agr铆colas, Ganaderas</option>
                <option value="625" {% if fiscal_regime == '625' %}selected{% endif %}>625 - Plataformas Tecnol贸gicas</option>
                <option value="626" {% if fiscal_regime == '626' %}selected{% endif %}>626 - Simplificado de Confianza (RESICO)</option>
            </select>
        </div>

        <!-- Uso de CFDI -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                Uso de CFDI <span style="color: #ef4444;">*</span>
            </label>
            <select class="form-select" name="uso_cfdi" required style="border: 1px solid #e5e7eb;">
                <option value="">Selecciona el uso...</option>
                <option value="G03">G03 - Gastos en general</option>
                <option value="D10">D10 - Pagos por servicios educativos</option>
                <option value="P01">P01 - Por definir</option>
                <option value="CP01" selected>CP01 - Pagos</option>
            </select>
            <small class="form-text text-muted">Uso que le dar谩s a esta factura en tu contabilidad</small>
        </div>

        <!-- C贸digo Postal -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                C贸digo Postal <span style="color: #ef4444;">*</span>
            </label>
            <input type="text"
                   class="form-control"
                   name="codigo_postal"
                   value="{{ codigo_postal }}"
                   required
                   pattern="[0-9]{5}"
                   maxlength="5"
                   style="border: 1px solid #e5e7eb;">
        </div>

        <!-- Forma de Pago -->
        <div class="mb-3">
            <label class="form-label" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                Forma de Pago
            </label>
            <select class="form-select" name="forma_pago" required style="border: 1px solid #e5e7eb;">
                <option value="03" selected>03 - Transferencia electr贸nica de fondos</option>
                <option value="04">04 - Tarjeta de cr茅dito</option>
                <option value="28">28 - Tarjeta de d茅bito</option>
                <option value="99">99 - Por definir</option>
            </select>
        </div>
    </div>

    <!-- Actions -->
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <a href="{% url 'billing:index' %}"
           class="btn btn-outline-secondary"
           style="padding: 0.75rem 1.5rem;">
            Cancelar
        </a>
        <button type="submit"
                class="btn btn-primary"
                style="background: #0d9488; border: none; padding: 0.75rem 1.5rem;">
             Generar Factura CFDI
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.getElementById('invoice-form')?.addEventListener('submit', function(e) {
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
    btn.disabled = true;

    // Form will submit normally
});
</script>
{% endblock %}
