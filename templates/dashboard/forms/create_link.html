<form id="createLinkForm" novalidate>
    {% csrf_token %}

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="title" class="form-label">
                    Título/Concepto <span class="text-danger">*</span>
                </label>
                <input type="text"
                       class="form-control"
                       id="title"
                       name="title"
                       required
                       minlength="3"
                       maxlength="255"
                       placeholder="Ej: Factura #001 - Consultoría Web"
                       autofocus
                       aria-required="true"
                       aria-invalid="false"
                       aria-describedby="title-error title-help">
                <div id="title-error" class="invalid-feedback" role="alert"></div>
                <small id="title-help" class="form-text text-muted">
                    Será visible en el link de pago
                </small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="amount" class="form-label">
                    Monto <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number"
                           class="form-control"
                           id="amount"
                           name="amount"
                           step="0.01"
                           min="1"
                           max="999999"
                           required
                           placeholder="0.00"
                           aria-required="true"
                           aria-invalid="false"
                           aria-describedby="amount-error amount-help">
                    <span class="input-group-text">MXN</span>
                </div>
                <div id="amount-error" class="invalid-feedback" role="alert"></div>
                <small id="amount-help" class="form-text text-muted">
                    Mínimo $1, máximo $999,999 MXN
                </small>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label for="description" class="form-label">Descripción <span class="text-muted small">(opcional)</span></label>
        <textarea class="form-control"
                  id="description"
                  name="description"
                  rows="2"
                  maxlength="500"
                  placeholder="Descripción opcional del servicio o producto"
                  aria-describedby="description-count"></textarea>
        <small id="description-count" class="form-text text-muted">
            <span id="descriptionCount">0</span>/500 caracteres
        </small>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="customer_name" class="form-label">Nombre del cliente <span class="text-muted small">(opcional)</span></label>
                <input type="text"
                       class="form-control"
                       id="customer_name"
                       name="customer_name"
                       maxlength="255"
                       placeholder="Nombre completo"
                       list="recent-customers-names"
                       aria-invalid="false"
                       aria-describedby="customer-name-error">
                <datalist id="recent-customers-names">
                    <!-- Will be populated dynamically -->
                </datalist>
                <div id="customer-name-error" class="invalid-feedback" role="alert"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="customer_email" class="form-label">
                    Email del cliente
                    <span class="text-danger" id="email-required-indicator">*</span>
                    <span class="text-muted small" id="email-optional-indicator" style="display: none;">(opcional)</span>
                </label>
                <input type="email"
                       class="form-control"
                       id="customer_email"
                       name="customer_email"
                       maxlength="254"
                       placeholder="cliente@ejemplo.com"
                       list="recent-customers-emails"
                       required
                       aria-required="true"
                       aria-invalid="false"
                       aria-describedby="customer-email-error customer-email-help">
                <datalist id="recent-customers-emails">
                    <!-- Will be populated dynamically -->
                </datalist>
                <div id="customer-email-error" class="invalid-feedback" role="alert"></div>
                <small id="customer-email-help" class="form-text text-muted">
                    <i class="iconoir-info-circle me-1"></i>
                    <span id="email-help-text">Requerido para enviar notificaciones</span>
                </small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="expires_days" class="form-label">
                    Vigencia del link <span class="text-danger">*</span>
                </label>
                <select class="form-select"
                        id="expires_days"
                        name="expires_days"
                        required
                        aria-required="true"
                        aria-invalid="false"
                        aria-describedby="expires-error">
                    <option value="1">1 día</option>
                    <option value="3" selected>3 días (recomendado)</option>
                    <option value="7">7 días</option>
                </select>
                <div id="expires-error" class="invalid-feedback" role="alert"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <div class="form-check mt-4">
                    <input class="form-check-input"
                           type="checkbox"
                           id="requires_invoice"
                           name="requires_invoice"
                           aria-describedby="requires-invoice-help">
                    <label class="form-check-label" for="requires_invoice">
                        <strong>Permitir facturar</strong>
                    </label>
                    <div id="requires-invoice-help" class="form-text">
                        El cliente podrá generar su CFDI 4.0
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Separador -->
    <hr class="notification-separator">

    <!-- Sección de Notificaciones - Propuesta 4 Compacta Horizontal -->
    <div id="notifications-section">
        <h6>Notificaciones</h6>

        <!-- Al crear -->
        <div class="notification-item">
            <span class="notification-item-bullet">━</span>
            <span class="notification-item-title">Al crear</span>
            <div class="notification-context">
                <label class="notification-toggle">
                    <input type="checkbox"
                           id="notify_on_create"
                           name="notify_on_create"
                           checked
                           onchange="toggleNotificationContext('notify_on_create')">
                    <span class="notification-toggle-label" id="notify_on_create_label">Activado</span>
                </label>
                <span class="notification-context-text active" id="notify_on_create_context">
                    <span id="preview-email">cliente@ejemplo.com</span>
                </span>
            </div>
        </div>

        <!-- Recordatorio -->
        <div class="notification-item">
            <span class="notification-item-bullet">━</span>
            <span class="notification-item-title">Recordatorio</span>
            <div class="notification-context">
                <label class="notification-toggle">
                    <input type="checkbox"
                           id="send_reminders"
                           name="send_reminders"
                           checked
                           onchange="toggleNotificationContext('send_reminders')">
                    <span class="notification-toggle-label" id="send_reminders_label">Activado</span>
                </label>
                <div id="send_reminders_context" style="display: inline-flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <div class="timing-pills">
                        <button type="button" class="timing-pill" data-hours="6" onclick="selectReminderTiming(6)">6h</button>
                        <button type="button" class="timing-pill" data-hours="12" onclick="selectReminderTiming(12)">12h</button>
                        <button type="button" class="timing-pill active" data-hours="24" onclick="selectReminderTiming(24)">24h</button>
                        <button type="button" class="timing-pill" data-hours="48" onclick="selectReminderTiming(48)">2d</button>
                        <button type="button" class="timing-pill" data-hours="72" onclick="selectReminderTiming(72)">3d</button>
                    </div>
                    <input type="hidden" id="reminder_hours_before" name="reminder_hours_before" value="24">
                    <span class="notification-info" id="reminder-scheduled-info">
                        <i class="iconoir-calendar"></i>
                        <span id="reminder-scheduled-time">16 ene, 14:30</span>
                    </span>
                    <span id="reminder-context-msg"></span>
                </div>
            </div>
        </div>

        <!-- Link expirado -->
        <div class="notification-item">
            <span class="notification-item-bullet">━</span>
            <span class="notification-item-title">Link expirado</span>
            <div class="notification-context">
                <label class="notification-toggle">
                    <input type="checkbox"
                           id="notify_on_expiry"
                           name="notify_on_expiry"
                           onchange="toggleNotificationContext('notify_on_expiry')">
                    <span class="notification-toggle-label" id="notify_on_expiry_label">Desactivado</span>
                </label>
            </div>
        </div>

        <!-- Automáticas -->
        <div class="automatic-notifications">
            <h6>Automáticas:</h6>
            <div class="automatic-notifications-list">
                <span class="auto-notification-item">Confirmación de pago</span>
                <span class="auto-notification-item" id="invoice-auto-notification" style="display: none;">Formulario de factura</span>
            </div>
        </div>

        <!-- Hidden input para mantener compatibilidad -->
        <input type="hidden" id="notifications_enabled" name="notifications_enabled" value="true">
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancelar
        </button>
        <button type="submit" class="btn btn-accent" id="submitLinkBtn">
            <span class="btn-content">
                <i class="iconoir-link me-2"></i>
                Crear Link de Pago
            </span>
            <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Creando...
            </span>
        </button>
    </div>
</form>


